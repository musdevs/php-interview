# Транзакции

Транзакции - последовательные запросы к БД, которые выполняются успешно все или не выполняется ни один.

## ACID - требования к транзакциям

### Atomicity - Атомарность - неделимая, не может выполняться частично

### Consistency - Согласованность - переход из одного согласованного состояния в другое

### Isolation - Изоляция - изменения внутри транзакции не видны другим

### Durability - Долговечность (прочность) - после фиксации данные не должны потеряться из-за сбоев

## Режим автоматической фиксации 

**SET AUTOCOMMIT = 0** - у пользователя постоянно есть открытая транзакция. После COMMIT или ROLLBACK запускается новая. 

```sql
SHOW VARIABLES WHERE Variable_name='autocommit';
+---------------+-------+
| Variable_name | Value |
+---------------+-------+
| autocommit    | ON    |
+---------------+-------+
```

## Уровни изоляции транзакций

Изолированность транзакции показывает как влияют друг на друга одновременно выполняющиеся транзакции

```sql
SHOW VARIABLES LIKE '%tx_isolation%';
+---------------+----------------+
| Variable_name | Value          |
+---------------+----------------+
| tx_isolation  | READ-COMMITTED |
+---------------+----------------+
```

### Read uncommitted

**Грязное чтение** (dirty read). Каждая транзакция видит незафиксированные изменения другой транзакции. Можно использовать для примерных расчетов, отладки.

### Read committed

**Неповторяющееся чтение** (nonrepeatable read) - чтение одних и тех же данных, которые в это время изменяются другими транзакциями, может выдавать разные результаты. Видим обновленные и удаленные строки (UPDATE, DELETE)

Транзакция видит только зафиксированные изменения других транзакций (на момент начала транзакции). Изменения транзакции не видны другим до окончания коммита.

### Repeatable read (по умолчанию в MySQL)

Повторное считывание одних и тех же данных внутри транзакции выдает один и тот же результат.

Возможно **фантомное чтение**, когда могут считываться новые строки, вставленные другой транзакцией.  

### Serializable

Блокируется каждая читаемая строка.


| Уровень          | Черновое | Неповторяющееся | Фантомное | Блокировка |
|:-----------------|:--------:|:---------------:|:---------:|:----------:|
| Read uncommitted | Да       | Да              | Да        | Нет        |
| Read committed   | Нет      | Да              | Да        | Нет        |
| Repeatable read  | Нет      | Нет             | Да        | Нет        |
| Serializable     | Нет      | Нет             | Нет       | Да         |


## Links

* [MySQL: уровни изоляции транзакций](https://habr.com/ru/post/135217/)
* [Уровни изолированности транзакций для самых маленьких](https://habr.com/ru/post/469415/)
* MySQL по максимуму. Шварц, Зайцев, Ткаченко