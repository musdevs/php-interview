# Swoole

[Docker Image for Swoole](https://github.com/swoole/docker-swoole)
[Docker Image for Swoole](https://hub.docker.com/r/phpswoole/swoole)

## Отладка

### XDebug

[Отладка сервиса на базе Swoole с помощью xdebug](https://docs.ensi.tech/backend-guides/principles/xdebug)

Для создания точки останова нужно добавить вызов

```php
xdebug_break();
```

### Yasd

[How to Use Yasd With Phpstorm](https://github.com/deminy/yasd-demo)
#### Yasd segmentation fault

[Тут](https://github.com/swoole/yasd/issues/41) описана ошибка сегментации

```shell
$ php7.4 -v
PHP 7.4.13 (cli) (built: Nov 28 2020 06:24:43) ( NTS )
Copyright (c) The PHP Group
Zend Engine v3.4.0, Copyright (c) Zend Technologies
    with Yasd v0.2.6, Our Copyright, by codinghuang
    with Zend OPcache v7.4.13, Copyright (c), by Zend Technologies
```
```shell
$ php7.4 --ri yasd

yasd

Yasd => enabled
Author => codinghuang <codinghuang@qq.com>
Version => 0.2.6
Built => Dec 22 2020 18:07:46

Directive => Local Value => Master Value
yasd.breakpoints_file => no value => no value
yasd.debug_mode => remote => remote
yasd.remote_host => 127.0.0.1 => 127.0.0.1
yasd.remote_port => 9000 => 9000
yasd.depth => 1 => 1
```

```shell
$ yasd git:(master) php7.4 -e test.php
[1]    6544 segmentation fault (core dumped)  php7.4 -e test.php
```
```shell
$ yasd git:(master) ✗ gdb php7.4 -c core
GNU gdb (Ubuntu 8.1-0ubuntu3.2) 8.1.0.20180409-git
Copyright (C) 2018 Free Software Foundation, Inc.
License GPLv3+: GNU GPL version 3 or later <http://gnu.org/licenses/gpl.html>
This is free software: you are free to change and redistribute it.
There is NO WARRANTY, to the extent permitted by law.  Type "show copying"
and "show warranty" for details.
This GDB was configured as "x86_64-linux-gnu".
Type "show configuration" for configuration details.
For bug reporting instructions, please see:
<http://www.gnu.org/software/gdb/bugs/>.
Find the GDB manual and other documentation resources online at:
<http://www.gnu.org/software/gdb/documentation/>.
For help, type "help".
Type "apropos word" to search for commands related to "word"...
Reading symbols from php7.4...(no debugging symbols found)...done.
[New LWP 6544]
[Thread debugging using libthread_db enabled]
Using host libthread_db library "/lib/x86_64-linux-gnu/libthread_db.so.1".
Core was generated by `php7.4 -e test.php'.
Program terminated with signal SIGSEGV, Segmentation fault.
#0  0x00007fcd9a73e34c in yasd::Util::is_hit_watch_point () at /home/jobin/software/yasd/src/util.cc:278
278         zend_function *func = EG(current_execute_data)->func;
(gdb) bt
#0  0x00007fcd9a73e34c in yasd::Util::is_hit_watch_point () at /home/jobin/software/yasd/src/util.cc:278
#1  0x00007fcd9a73c0c3 in yasd_statement_call (frame=<optimized out>) at /home/jobin/software/yasd/yasd.cc:173
#2  0x0000556c79a710a2 in zend_llist_apply_with_argument ()
#3  0x0000556c798d622b in ?? ()
#4  0x0000556c79b03fac in execute_ex ()
#5  0x00007fcd9a73ebbf in yasd_execute_ex (execute_data=0x7fcd9ae13020) at /home/jobin/software/yasd/src/base.cc:96
#6  0x0000556c79b0a4a2 in zend_execute ()
#7  0x0000556c79a7d532 in zend_execute_scripts ()
#8  0x0000556c79a1c070 in php_execute_script ()
#9  0x0000556c79b0c4a3 in ?? ()
#10 0x0000556c798d79e6 in ?? ()
#11 0x00007fcd9daa7b97 in __libc_start_main (main=0x556c798d75d0, argc=3, argv=0x7fffb580d7b8, init=<optimized out>, fini=<optimized out>, rtld_fini=<optimized out>,
    stack_end=0x7fffb580d7a8) at ../csu/libc-start.c:310
#12 0x0000556c798d7b8a in _start ()
(gdb)
```

Как запустить gdb нужно [разобраться](https://www.google.com/search?q=gdb+inside+docker+php+container&sca_esv=566856875&ei=VNQKZYy7D7HLrgTjobD4CQ&ved=0ahUKEwiMtYrzh7mBAxWxpYsKHeMQDJ8Q4dUDCBA&uact=5&oq=gdb+inside+docker+php+container&gs_lp=Egxnd3Mtd2l6LXNlcnAiH2dkYiBpbnNpZGUgZG9ja2VyIHBocCBjb250YWluZXIyBRAAGKIEMgUQABiiBDIFEAAYogRIixNQ-QtY_RBwAXgBkAEAmAFgoAGhAqoBATS4AQPIAQD4AQHCAgoQABhHGNYEGLADwgIHEAAYDRiABMICCBAAGAUYHhgN4gMEGAAgQYgGAZAGCA&sclient=gws-wiz-serp)


Локально удалось увидеть ошибку так:
```shell
sudo tail -f /var/log/syslog
Sep 19 17:46:04 legion kernel: [199154.967770] php[398423]: segfault at 1c ip 00007f06dc6bc4e3 sp 00007ffff13a37a0 error 4 in yasd.so[7f06dc6b4000+2b000] likely on CPU 8 (core 4, socket 0)
Sep 19 17:46:04 legion kernel: [199154.967780] Code: 00 03 75 13 48 83 c4 08 5b 5d 41 5c 41 5d ff 25 7b 6f 03 00 0f 1f 00 e8 9b 95 ff ff 84 c0 75 77 48 8b 1d 28 28 03 00 48 8b 3b <80> 7f 1c 00 75 77 e8 f2 94 ff ff 48 89 ef 48 83 40 08 01 48 89 c3
```
